<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>êµ­ê°€ìœ ì‚° ì‹¤ì‹œê°„ ì¸í„°ë™í‹°ë¸Œ ì§€ë„</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    
    <script src="https://unpkg.com/maplibre-gl@3.x/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.x/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/pmtiles@2.x/dist/index.js"></script>

    <style>
        body { margin: 0; padding: 0; font-family: 'Malgun Gothic', sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }

        /* ê²€ìƒ‰ì°½ UI */
        #search-box {
            position: absolute; top: 20px; left: 20px; z-index: 1000;
            background: white; padding: 12px; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); width: 280px;
        }
        .search-container { display: flex; gap: 5px; }
        #search-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; outline: none; }
        #search-box button { padding: 10px 15px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        
        /* ê²€ìƒ‰ ê²°ê³¼ ëª©ë¡ */
        #search-results {
            margin-top: 10px; max-height: 250px; overflow-y: auto;
            border-top: 1px solid #eee; display: none;
        }
        .result-item { padding: 12px; cursor: pointer; font-size: 13px; border-bottom: 1px solid #f5f5f5; line-height: 1.4; }
        .result-item:hover { background: #f0f7ff; color: #007bff; }
        .result-item small { color: #888; display: block; margin-top: 2px; }

        /* ë²”ë¡€ ìŠ¤íƒ€ì¼ */
        #legend {
            position: absolute; bottom: 30px; left: 10px; z-index: 100;
            background: rgba(255, 255, 255, 0.95); padding: 15px;
            border-radius: 8px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.1); min-width: 150px;
        }
        #legend h4 { margin: 0 0 10px 0; font-size: 14px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        .legend-item { display: flex; align-items: center; font-size: 13px; margin-bottom: 6px; cursor: pointer; }
        .legend-item input { margin-right: 10px; cursor: pointer; }
        .legend-item span { width: 14px; height: 14px; margin-right: 10px; border-radius: 2px; border: 1px solid rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<div id="map"></div>

<div id="search-box">
    <div class="search-container">
        <input type="text" id="search-input" placeholder="êµ­ê°€ìœ ì‚° ëª…ì¹­ ì…ë ¥ (ì˜ˆ: ë¶ˆêµ­ì‚¬)">
        <button onclick="searchHeritage()">ê²€ìƒ‰</button>
    </div>
    <div id="search-results"></div>
</div>

<div id="legend">
    <h4>ì¢…ëª© í•„í„°</h4>
    <div class="legend-item"><input type="checkbox" id="chk-11" checked onclick="updateFilter()"><span style="background:#e6194b;"></span> êµ­ë³´ (11)</div>
    <div class="legend-item"><input type="checkbox" id="chk-12" checked onclick="updateFilter()"><span style="background:#3cb44b;"></span> ë³´ë¬¼ (12)</div>
    <div class="legend-item"><input type="checkbox" id="chk-13" checked onclick="updateFilter()"><span style="background:#ffe119;"></span> ì‚¬ì  (13)</div>
    <div class="legend-item"><input type="checkbox" id="chk-14" checked onclick="updateFilter()"><span style="background:#4363d8;"></span> ì‚¬ì  ë° ëª…ìŠ¹ (14)</div>
    <div class="legend-item"><input type="checkbox" id="chk-15" checked onclick="updateFilter()"><span style="background:#f58231;"></span> ëª…ìŠ¹ (15)</div>
    <div class="legend-item"><input type="checkbox" id="chk-16" checked onclick="updateFilter()"><span style="background:#911eb4;"></span> ì²œì—°ê¸°ë…ë¬¼ (16)</div>
    <div class="legend-item"><input type="checkbox" id="chk-18" checked onclick="updateFilter()"><span style="background:#888888;"></span> êµ­ê°€ë¯¼ì†ìœ ì‚° (18)</div>
</div>

<script>
    // 1. PMTiles ì„¤ì •
    let protocol = new pmtiles.Protocol();
    maplibregl.addProtocol("pmtiles", protocol.tile);

    // 2. ì§€ë„ ì´ˆê¸°í™”
    const map = new maplibregl.Map({
        container: 'map',
        style: {
            "version": 8,
            "sources": {
                "osm": {
                    "type": "raster",
                    "tiles": ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
                    "tileSize": 256,
                    "attribution": "&copy; OpenStreetMap"
                }
            },
            "layers": [{"id": "osm-layer", "type": "raster", "source": "osm"}]
        },
        center: [127.0, 37.5], 
        zoom: 11
    });

    // 3. êµ­ê°€ìœ ì‚°ì²­ APIë¡œë¶€í„° ìƒì„¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ê³µí†µ í•¨ìˆ˜
    async function fetchHeritageDetail(name) {
        const targetUrl = `https://www.khs.go.kr/cha/SearchKindOpenapiList.do?ccbaNm=${encodeURIComponent(keyword)}`; 
        try {
            const response = await fetch(targetUrl);
            const text = await response.text();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(text, "text/xml");
            const items = xmlDoc.getElementsByTagName("item");
            return items.length > 0 ? items[0] : null;
        } catch (e) {
            console.error("API Fetch Error:", e);
            return null;
        }
    }

    // 4. ê²€ìƒ‰ì°½ ê²€ìƒ‰ í•¨ìˆ˜
    async function searchHeritage() {
        const keyword = document.getElementById('search-input').value.trim();
        const resultsDiv = document.getElementById('search-results');
        if (!keyword) return alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

        resultsDiv.innerHTML = '<div class="result-item">ê²€ìƒ‰ ì¤‘...</div>';
        resultsDiv.style.display = 'block';

        const apiUrl = `https://www.khs.go.kr/cha/SearchKindOpenapiList.do?ccbaNm=${encodeURIComponent(keyword)}`;

        try {
            const response = await fetch(apiUrl);
            const text = await response.text();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(text, "text/xml");
            const items = xmlDoc.getElementsByTagName("item");

            resultsDiv.innerHTML = '';
            if (items.length > 0) {
                Array.from(items).forEach(item => {
                    const name = item.getElementsByTagName("ccbaNm")[0].textContent;
                    const region = item.getElementsByTagName("ccbaCtcdNm")[0].textContent;
                    const lon = item.getElementsByTagName("longitude")[0].textContent;
                    const lat = item.getElementsByTagName("latitude")[0].textContent;

                    const div = document.createElement('div');
                    div.className = 'result-item';
                    div.innerHTML = `<strong>ğŸ“ ${name}</strong><small>${region}</small>`;
                    
                    div.onclick = () => {
                        if (lon && lat && lon !== "0") {
                            map.flyTo({ center: [parseFloat(lon), parseFloat(lat)], zoom: 16 });
                            showPopup(parseFloat(lon), parseFloat(lat), name, item);
                            resultsDiv.style.display = 'none';
                        } else {
                            alert("ìœ„ì¹˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
                        }
                    };
                    resultsDiv.appendChild(div);
                });
            } else {
                resultsDiv.innerHTML = '<div class="result-item">ì¼ì¹˜í•˜ëŠ” ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        } catch (e) {
            resultsDiv.innerHTML = '<div class="result-item">API ì—°ê²° ì‹¤íŒ¨</div>';
        }
    }

    // 5. íŒì—… í‘œì‹œ ê³µí†µ í•¨ìˆ˜
    function showPopup(lon, lat, name, apiItem) {
        const gcodeName = apiItem.getElementsByTagName("ccmaName")[0]?.textContent || "ì •ë³´ ì—†ìŒ";
        const bcodeName = apiItem.getElementsByTagName("ccbaCtcdNm")[0]?.textContent || "ì •ë³´ ì—†ìŒ";
        const asno = apiItem.getElementsByTagName("ccbaAsno")[0]?.textContent || "";
        
        // êµ­ê°€ìœ ì‚°ì²­ ê³µì‹ ìƒì„¸í˜ì´ì§€ ì¡°í•©
        const kdcd = apiItem.getElementsByTagName("ccbaKdcd")[0]?.textContent;
        const ctcd = apiItem.getElementsByTagName("ccbaCtcd")[0]?.textContent;
        const detailUrl = `https://www.heritage.go.kr/heri/cul/culSelectDetail.do?VdkVgwKey=${kdcd}_${asno}_${ctcd}`;

        let html = `<div style="width:200px; padding:5px;">`;
        html += `<strong style="font-size:14px; color:#007bff;">${name}</strong><hr style="margin:8px 0; border:0; border-top:1px solid #eee;">`;
        html += `<div style="font-size:12px; margin-bottom:3px;"><b>ì¢…ëª©:</b> ${gcodeName}</div>`;
        html += `<div style="font-size:12px; margin-bottom:10px;"><b>ì§€ì—­:</b> ${bcodeName}</div>`;
        html += `<a href="${detailUrl}" target="_blank" style="display:block; padding:8px; background:#28a745; color:white; text-align:center; text-decoration:none; border-radius:4px; font-size:12px;">ê³µì‹ ìƒì„¸ì •ë³´ ë³´ê¸°</a>`;
        html += `</div>`;

        new maplibregl.Popup().setLngLat([lon, lat]).setHTML(html).addTo(map);
    }

    // 6. ì§€ë„ ë ˆì´ì–´ ë¡œë“œ ë° í´ë¦­ ì´ë²¤íŠ¸
    map.on('load', () => {
        map.addSource('my-data', { type: 'vector', url: 'pmtiles://my_map.pmtiles' });

        map.addLayer({
            'id': 'my-layer',
            'type': 'fill',
            'source': 'my-data',
            'source-layer': 'input',
            'paint': {
                'fill-color': [
                    'match', ['get', 'ì¢…ëª©ì½”ë“œ'],
                    '11', '#e6194b', '12', '#3cb44b', '13', '#ffe119',
                    '14', '#4363d8', '15', '#f58231', '16', '#911eb4', '18', '#888888', '#cccccc'
                ],
                'fill-opacity': 0.65,
                'fill-outline-color': '#ffffff'
            }
        });

        // [í•µì‹¬] ì§€ë„ í´ë¦­ ì‹œ ì‹¤ì‹œê°„ API í˜¸ì¶œ
        map.on('click', 'my-layer', async (e) => {
            const name = e.features[0].properties['ë¬¸í™”ìœ ì‚°ëª…'];
            if (!name) return;

            const tempPopup = new maplibregl.Popup().setLngLat(e.lngLat).setHTML(`<strong>${name}</strong><br>ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...`).addTo(map);

            const apiItem = await fetchHeritageDetail(name);
            if (apiItem) {
                tempPopup.remove();
                showPopup(e.lngLat.lng, e.lat.lat, name, apiItem);
            } else {
                tempPopup.setHTML(`<strong>${name}</strong><br>ìƒì„¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.`);
            }
        });

        map.on('mouseenter', 'my-layer', () => map.getCanvas().style.cursor = 'pointer');
        map.on('mouseleave', 'my-layer', () => map.getCanvas().style.cursor = '');
    });

    // 7. í•„í„° ë° ì—”í„°í‚¤ ì œì–´
    function updateFilter() {
        const codes = [];
        for(let i=11; i<=16; i++) { if(document.getElementById(`chk-${i}`).checked) codes.push(i); }
        map.setFilter('my-layer', codes.length === 0 ? ['==', ['get', 'ì¢…ëª©ì½”ë“œ'], 'none'] : ['in', ['get', 'ì¢…ëª©ì½”ë“œ'], ['literal', codes]]);
    }

    document.getElementById('search-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') searchHeritage(); });
</script>
</body>
</html>
















