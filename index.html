<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>국가유산 지도 - 로딩 최적화</title>
    <script src="https://unpkg.com/maplibre-gl@3.x/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.x/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        #loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.9); padding: 20px; border-radius: 10px;
            z-index: 9999; box-shadow: 0 0 10px rgba(0,0,0,0.2); font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="loader">데이터 분석 중 (13MB)... 잠시만 기다려주세요.</div>
    <div id="map"></div>

    <script>
        const loader = document.getElementById('loader');

        const map = new maplibregl.Map({
            container: 'map',
            style: {
                "version": 8,
                "sources": {
                    "osm": { "type": "raster", "tiles": ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"], "tileSize": 256 }
                },
                "layers": [{ "id": "osm", "type": "raster", "source": "osm" }]
            },
            center: [127.5, 36.5],
            zoom: 7
        });

        map.on('load', async () => {
            try {
                // 1. 데이터 가져오기
                const response = await fetch('input.json');
                if (!response.ok) throw new Error("파일 로드 실패");
                const data = await response.json();
                
                loader.innerText = "지도에 그리는 중...";

                // 2. 소스 추가 (클러스터링 비활성화로 우선 테스트)
                // 13MB 폴리곤 데이터는 클러스터링 계산 시 멈출 수 있으므로 일단 false로 테스트 권장
                map.addSource('heritage-source', {
                    type: 'geojson',
                    data: data,
                    cluster: false 
                });
// 1. 소스 수정 (클러스터 다시 활성화)
map.getSource('heritage-source').setData(data); // 데이터 재설정
map.getSource('heritage-source').cluster = true; // 클러스터 켜기

// 2. [멀리서] 클러스터 원 (데이터가 뭉쳐진 상태)
map.addLayer({
    id: 'clusters',
    type: 'circle',
    source: 'heritage-source',
    filter: ['has', 'point_count'],
    maxzoom: 13, // 줌 13까지만 보임
    paint: {
        'circle-color': ['step', ['get', 'point_count'], '#51bbd6', 50, '#f1f075', 200, '#f28cb1'],
        'circle-radius': ['step', ['get', 'point_count'], 20, 50, 30, 200, 40],
        'circle-stroke-width': 2,
        'circle-stroke-color': '#fff'
    }
});

// 3. [멀리서] 클러스터 숫자
map.addLayer({
    id: 'cluster-count',
    type: 'symbol',
    source: 'heritage-source',
    filter: ['has', 'point_count'],
    maxzoom: 13,
    layout: {
        'text-field': '{point_count}',
        'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
        'text-size': 12
    }
});

// 4. [중간] 개별 점 (폴리곤의 중심점 자동 생성)
map.addLayer({
    id: 'unclustered-point',
    type: 'circle',
    source: 'heritage-source',
    filter: ['!', ['has', 'point_count']],
    maxzoom: 14,
    paint: {
        'circle-color': [
            'match', ['get', '종목코드'],
            11, '#e6194b', 12, '#3cb44b', 13, '#ffe119', 14, '#4363d8', 
            15, '#f58231', 16, '#911eb4', 18, '#888888', '#cccccc'
        ],
        'circle-radius': 6,
        'circle-stroke-width': 2,
        'circle-stroke-color': '#fff'
    }
});

// 5. [가까이] 실제 폴리곤 (상세 경계)
map.addLayer({
    id: 'heritage-polygon',
    type: 'fill',
    source: 'heritage-source',
    minzoom: 12, // 줌 12부터 서서히 나타남
    paint: {
        'fill-color': [
            'match', ['get', '종목코드'],
            11, '#e6194b', 12, '#3cb44b', 13, '#ffe119', 14, '#4363d8', 
            15, '#f58231', 16, '#911eb4', 18, '#888888', '#cccccc'
        ],
        'fill-opacity': ['interpolate', ['linear'], ['zoom'], 12, 0, 14, 0.6],
        'fill-outline-color': '#ffffff'
    }
});
    
    </script>
</body>
</html>




