<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>문화재 공간정보 서비스 - 클러스터 복구</title>
    <script src="https://unpkg.com/maplibre-gl@3.x/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.x/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/pmtiles@2.x/dist/index.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        #legend { position: absolute; bottom: 30px; left: 10px; z-index: 100; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.2); font-family: sans-serif; }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        let protocol = new pmtiles.Protocol();
        maplibregl.addProtocol("pmtiles", protocol.tile);

        const map = new maplibregl.Map({
            container: 'map',
            style: {
                "version": 8,
                "glyphs": "https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf",
                "sources": {
                    "osm": { "type": "raster", "tiles": ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"], "tileSize": 256 }
                },
                "layers": [{"id": "osm-layer", "type": "raster", "source": "osm"}]
            },
            center: [127.5, 36.5], 
            zoom: 7
        });

map.on('load', async () => {
    try {
        const res = await fetch('input1.json');
        const geojson = await res.json();

        // 1. 소스 설정: 클러스터링 활성화
        map.addSource('point-source', {
            type: 'geojson',
            data: geojson,
            cluster: true,
            clusterMaxZoom: 11, // 줌 11까지만 뭉치고, 그 이상은 개별 점으로 보임
            clusterRadius: 50
        });

        // 2. [줌 0 ~ 11] 클러스터 원 레이어
        map.addLayer({
            id: 'cluster-circles',
            type: 'circle',
            source: 'point-source',
            filter: ['has', 'point_count'],
            maxzoom: 12, // 줌 12가 넘어가면 화면에서 숨김 (상세 폴리곤에 양보)
            paint: {
                'circle-color': ['step', ['get', 'point_count'], '#51bbd6', 50, '#f1f075', 200, '#f28cb1'],
                'circle-radius': ['step', ['get', 'point_count'], 20, 50, 25, 200, 30],
                'circle-stroke-width': 2,
                'circle-stroke-color': '#fff'
            }
        });

        // 3. [줌 0 ~ 11] 클러스터 숫자 레이어
        map.addLayer({
            id: 'cluster-labels',
            type: 'symbol',
            source: 'point-source',
            filter: ['has', 'point_count'],
            maxzoom: 12, // 줌 12가 넘어가면 숨김
            layout: {
                'text-field': '{point_count}',
                'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
                'text-size': 12,
                'text-allow-overlap': true
            }
        });

        // 4. [줌 0 ~ 11] 개별 포인트 레이어 (unclustered)
        map.addLayer({
            id: 'unclustered-point',
            type: 'circle',
            source: 'point-source',
            filter: ['!', ['has', 'point_count']],
            maxzoom: 12,
            paint: {
                'circle-color': '#e6194b',
                'circle-radius': 6,
                'circle-stroke-width': 1.5,
                'circle-stroke-color': '#fff'
            }
        });

        // 5. [줌 11 ~ 22] PMTiles 상세 폴리곤 (확대했을 때 나타남)
        map.addLayer({
            'id': 'pmtiles-layer',
            'type': 'fill',
            'source': 'pmtiles-source',
            'source-layer': 'input', 
            'maxzoom': 11, // 줌 11보다 작을 때는 나타나지 않음
            'paint': {
                'fill-color': '#3cb44b',
                'fill-opacity': 0.6
            }
        });

    } catch (e) {
        console.error("오류 발생:", e);
    }
});
    </script>
</body>
</html>


