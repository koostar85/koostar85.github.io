<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>국가유산 지도 - LOD 최적화</title>
    <script src="https://unpkg.com/maplibre-gl@3.x/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.x/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        #loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.9); padding: 20px; border-radius: 10px;
            z-index: 9999; box-shadow: 0 0 10px rgba(0,0,0,0.2); font-weight: bold;
            display: block; /* 초기 로더 표시 */
        }
    </style>
</head>
<body>

    <div id="loader">단순화 데이터 로딩 중...</div>
    <div id="map"></div>

    <script>
        const loader = document.getElementById('loader');

        const map = new maplibregl.Map({
            container: 'map',
            style: {
                "version": 8,
                // 폰트 에러 방지를 위해 glyphs 추가
                "glyphs": "https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf",
                "sources": {
                    "osm": { "type": "raster", "tiles": ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"], "tileSize": 256 }
                },
                "layers": [{ "id": "osm", "type": "raster", "source": "osm" }]
            },
            center: [127.5, 36.5],
            zoom: 10
        });

map.on('load', async () => {
    try {
        const simpleRes = await fetch('input_simple.json');
        const simpleData = await simpleRes.json();

        // [핵심 수정] 폴리곤 데이터를 클러스터링 가능한 포인트 소스로 등록
        map.addSource('heritage-simple', {
            type: 'geojson',
            data: simpleData,
            cluster: true,
            clusterMaxZoom: 12,
            clusterRadius: 50,
            // 폴리곤의 중심점을 클러스터 기준으로 사용하도록 설정
            clusterProperties: {
                "sum": ["+", ["get", "종목코드"]] // 필요한 경우 속성 합산 가능
            }
        });

        // 1. 클러스터 원 레이어 (가장 상단에 배치)
        map.addLayer({
            id: 'clusters-simple',
            type: 'circle',
            source: 'heritage-simple',
            filter: ['has', 'point_count'], // 클러스터 된 것만
            maxzoom: 13,
            paint: {
                'circle-color': [
                    'step', ['get', 'point_count'],
                    '#51bbd6', 50, 
                    '#f1f075', 200, 
                    '#f28cb1'
                ],
                'circle-radius': [
                    'step', ['get', 'point_count'],
                    20, 50, 25, 200, 30
                ],
                'circle-stroke-width': 2,
                'circle-stroke-color': '#fff'
            }
        });

        // 2. 클러스터 숫자 레이어
        map.addLayer({
            id: 'cluster-count-simple',
            type: 'symbol',
            source: 'heritage-simple',
            filter: ['has', 'point_count'],
            maxzoom: 13,
            layout: {
                'text-field': '{point_count}',
                'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
                'text-size': 14,
                'text-allow-overlap': true // 글자가 겹쳐도 보이게 설정
            },
            paint: {
                'text-color': '#000'
            }
        });

        // 3. 개별 점 레이어 (클러스터 되지 않은 항목)
        map.addLayer({
            id: 'unclustered-point-simple',
            type: 'circle',
            source: 'heritage-simple',
            filter: ['!', ['has', 'point_count']],
            maxzoom: 13,
            paint: {
                'circle-color': '#e6194b', // 눈에 띄는 빨간색으로 우선 테스트
                'circle-radius': 6,
                'circle-stroke-width': 1.5,
                'circle-stroke-color': '#fff'
            }
        });

        // -----------------------------------------------------------------

        // 2. 원본 상세 파일 로드 (줌 13 이상 전용)
        const fullRes = await fetch('input.json');
        const fullData = await fullRes.json();
        
        map.addSource('heritage-full', {
            type: 'geojson',
            data: fullData
        });

        // [레이어 4] 줌 13 이상: 원본 정밀 폴리곤
        map.addLayer({
            id: 'poly-full',
            type: 'fill',
            source: 'heritage-full',
            minzoom: 13, // 줌 13부터 나타남
            paint: {
                'fill-color': [
                    'match', ['get', '종목코드'],
                    11, '#e6194b', 12, '#3cb44b', 13, '#ffe119', 
                    14, '#4363d8', 15, '#f58231', 16, '#911eb4', 18, '#888888', '#cccccc'
                ],
                'fill-opacity': 0.6,
                'fill-outline-color': '#ffffff'
            }
        });

        // [레이어 5] 줌 13 이상: 폴리곤 테두리 (시인성 확보)
        map.addLayer({
            id: 'poly-outline-full',
            type: 'line',
            source: 'heritage-full',
            minzoom: 13,
            paint: {
                'line-color': '#ffffff',
                'line-width': 1
            }
        });

        loader.style.display = 'none';

    } catch (err) {
        console.error("LOD 로딩 에러:", err);
    }
});
    </script>
</body>
</html>




