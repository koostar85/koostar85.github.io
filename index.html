<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>문화재 공간정보 서비스 - 클러스터 복구</title>
    <script src="https://unpkg.com/maplibre-gl@3.x/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.x/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/pmtiles@2.x/dist/index.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        #legend { position: absolute; bottom: 30px; left: 10px; z-index: 100; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.2); font-family: sans-serif; }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        let protocol = new pmtiles.Protocol();
        maplibregl.addProtocol("pmtiles", protocol.tile);

        const map = new maplibregl.Map({
            container: 'map',
            style: {
                "version": 8,
                "glyphs": "https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf",
                "sources": {
                    "osm": { "type": "raster", "tiles": ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"], "tileSize": 256 }
                },
                "layers": [{"id": "osm-layer", "type": "raster", "source": "osm"}]
            },
            center: [127.5, 36.5], 
            zoom: 7
        });

        map.on('load', async () => {
            try {
                // 1. input1.json 로드 및 데이터 교정
                const res = await fetch('input1.json');
                const geojson = await res.json();

                // [중요] 좌표가 문자열인 경우 숫자로 변환 (클러스터링 필수 조건)
                geojson.features = geojson.features.map(f => {
                    f.geometry.coordinates = [
                        Number(f.geometry.coordinates[0]),
                        Number(f.geometry.coordinates[1])
                    ];
                    return f;
                });

                // 2. 포인트 소스 추가 (클러스터 활성화)
                map.addSource('point-source', {
                    type: 'geojson',
                    data: geojson,
                    cluster: true,
                    clusterMaxZoom: 12,
                    clusterRadius: 50
                });

                // 3. PMTiles 소스 추가
                map.addSource('pmtiles-source', {
                    type: 'vector',
                    url: 'pmtiles://my_map.pmtiles'
                });

                // ---------------------------------------------------
                // 레이어 추가 순서: 아래에 깔릴 것부터 추가
                // ---------------------------------------------------

                // [1] PMTiles 폴리곤 (확대 시 보임)
                map.addLayer({
                    id: 'pmtiles-layer',
                    type: 'fill',
                    source: 'pmtiles-source',
                    'source-layer': 'input', 
                    minzoom: 11,
                    paint: {
                        'fill-color': ['match', ['get', '종목코드'], '11', '#e6194b', '12', '#3cb44b', '13', '#ffe119', '14', '#4363d8', '15', '#f58231', '16', '#911eb4', '18', '#888888', '#cccccc'],
                        'fill-opacity': 0.6
                    }
                });

                // [2] 클러스터 원 (항상 위쪽에 보이도록 폴리곤 다음에 추가)
                map.addLayer({
                    id: 'cluster-circles',
                    type: 'circle',
                    source: 'point-source',
                    filter: ['has', 'point_count'],
                    maxzoom: 12,
                    paint: {
                        'circle-color': ['step', ['get', 'point_count'], '#51bbd6', 50, '#f1f075', 200, '#f28cb1'],
                        'circle-radius': ['step', ['get', 'point_count'], 20, 50, 25, 200, 30],
                        'circle-stroke-width': 2,
                        'circle-stroke-color': '#fff'
                    }
                });

                // [3] 클러스터 숫자 (가장 위에 얹음)
                map.addLayer({
                    id: 'cluster-labels',
                    type: 'symbol',
                    source: 'point-source',
                    filter: ['has', 'point_count'],
                    maxzoom: 12,
                    layout: {
                        'text-field': '{point_count}',
                        'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
                        'text-size': 12,
                        'text-allow-overlap': true,
                        'text-ignore-placement': true
                    },
                    paint: { 'text-color': '#000' }
                });

                // [4] 개별 점 (클러스터 안 된 포인트)
                map.addLayer({
                    id: 'unclustered-point',
                    type: 'circle',
                    source: 'point-source',
                    filter: ['!', ['has', 'point_count']],
                    maxzoom: 12,
                    paint: {
                        'circle-color': ['match', ['get', '종목코드'], '11', '#e6194b', '12', '#3cb44b', '13', '#ffe119', '18', '#888888', '#51bbd6'],
                        'circle-radius': 6,
                        'circle-stroke-width': 1.5,
                        'circle-stroke-color': '#fff'
                    }
                });

            } catch (e) {
                console.error("클러스터 로드 에러:", e);
            }
        });
    </script>
</body>
</html>
