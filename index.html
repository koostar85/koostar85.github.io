<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>ë¬¸í™”ì¬ ê³µê°„ì •ë³´ ì„œë¹„ìŠ¤</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://unpkg.com/maplibre-gl@3.x/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.x/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/pmtiles@2.x/dist/index.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        /* ë²”ë¡€ ìŠ¤íƒ€ì¼ */
        #legend {
            position: absolute; bottom: 30px; left: 10px; z-index: 100;
            background: rgba(255, 255, 255, 0.9); padding: 15px; border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2); font-family: sans-serif;
            min-width: 150px;
        }
        #legend h4 { margin: 0 0 10px 0; font-size: 14px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        .legend-item { display: flex; align-items: center; font-size: 13px; margin-bottom: 5px; }
        .legend-item input { margin-right: 8px; cursor: pointer; }
        .legend-item span { width: 14px; height: 14px; margin-right: 8px; border-radius: 2px; display: inline-block; }

        /* ê²€ìƒ‰ì°½ ìŠ¤íƒ€ì¼ */
        #search-box {
            position: absolute; top: 20px; left: 20px; z-index: 1000;
            background: white; padding: 10px; border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        #search-input { width: 200px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; outline: none; }
        #search-results {
            margin-top: 10px; max-height: 200px; overflow-y: auto;
            background: white; border-top: 1px solid #eee; display: none;
        }
        .result-item { padding: 8px; cursor: pointer; font-size: 13px; border-bottom: 1px solid #f9f9f9; }
        .result-item:hover { background: #f0f7ff; color: #007bff; }
    </style>
</head>
<body>

<div id="map"></div>

<div id="search-box">
    <div style="display: flex; gap: 5px;">
        <input type="text" id="search-input" placeholder="ë¬¸í™”ìœ ì‚°ëª… ì…ë ¥ (ì˜ˆ: ê²½ë³µê¶)">
        <button onclick="searchHeritage()" style="padding: 8px 15px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">ê²€ìƒ‰</button>
    </div>
    <div id="search-results"></div>
</div> 

<div id="legend">
    <h4>êµ­ê°€ìœ ì‚° ë²”ë¡€</h4>
    <div class="legend-item"><input type="checkbox" id="chk-11" checked onclick="updateFilter()"><span style="background:#e6194b;"></span> êµ­ë³´ (11)</div>
    <div class="legend-item"><input type="checkbox" id="chk-12" checked onclick="updateFilter()"><span style="background:#3cb44b;"></span> ë³´ë¬¼ (12)</div>
    <div class="legend-item"><input type="checkbox" id="chk-13" checked onclick="updateFilter()"><span style="background:#ffe119;"></span> ì‚¬ì  (13)</div>
    <div class="legend-item"><input type="checkbox" id="chk-14" checked onclick="updateFilter()"><span style="background:#4363d8;"></span> ì‚¬ì ë°ëª…ìŠ¹ (14)</div>
    <div class="legend-item"><input type="checkbox" id="chk-15" checked onclick="updateFilter()"><span style="background:#f58231;"></span> ëª…ìŠ¹ (15)</div>
    <div class="legend-item"><input type="checkbox" id="chk-16" checked onclick="updateFilter()"><span style="background:#911eb4;"></span> ì²œì—°ê¸°ë…ë¬¼ (16)</div>
    <div class="legend-item"><input type="checkbox" id="chk-18" checked onclick="updateFilter()"><span style="background:#888888;"></span> êµ­ê°€ë¯¼ì†ë¬¸í™”ìœ ì‚° (18)</div>
</div>

<script>
    // 1. PMTiles í”„ë¡œí† ì½œ ë“±ë¡
    let protocol = new pmtiles.Protocol();
    maplibregl.addProtocol("pmtiles", protocol.tile);

    // 2. ì§€ë„ ì´ˆê¸°í™” (glyphs í•„ìˆ˜ ì¶”ê°€)
    const map = new maplibregl.Map({
        container: 'map',
        style: {
            "version": 8,
            "glyphs": "https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf",
            "sources": {
                "osm": {
                    "type": "raster",
                    "tiles": ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
                    "tileSize": 256,
                    "attribution": "&copy; OpenStreetMap"
                }
            },
            "layers": [{"id": "osm-layer", "type": "raster", "source": "osm"}]
        },
        center: [127.5, 36.5], 
        zoom: 7
    });

    let searchData = null;

    map.on('load', async () => {
        try {
            // [ë°ì´í„° ë¡œë“œ] í¬ì¸íŠ¸ ë°ì´í„°(input1.json)ì™€ ê²€ìƒ‰ìš©(input.json)
            const [resPoint, resFull] = await Promise.all([
                fetch('input1.json').then(r => r.json()),
                fetch('input.json').then(r => r.json())
            ]);
            searchData = resFull;

            // 3. í¬ì¸íŠ¸ í´ëŸ¬ìŠ¤í„° ì†ŒìŠ¤ ì¶”ê°€
            map.addSource('point-source', {
                type: 'geojson',
                data: resPoint,
                cluster: true,
                clusterMaxZoom: 11,
                clusterRadius: 50
            });

            // 4. í´ëŸ¬ìŠ¤í„° ì› ë ˆì´ì–´ (ì¤Œ 12 ë¯¸ë§Œ)
            map.addLayer({
                id: 'cluster-circles',
                type: 'circle',
                source: 'point-source',
                filter: ['has', 'point_count'],
                maxzoom: 12,
                paint: {
                    'circle-color': ['step', ['get', 'point_count'], '#51bbd6', 50, '#f1f075', 200, '#f28cb1'],
                    'circle-radius': ['step', ['get', 'point_count'], 20, 50, 25, 200, 30],
                    'circle-stroke-width': 2,
                    'circle-stroke-color': '#fff'
                }
            });

            // 5. í´ëŸ¬ìŠ¤í„° ìˆ«ì ë ˆì´ì–´ (ì¤Œ 12 ë¯¸ë§Œ)
            map.addLayer({
                id: 'cluster-labels',
                type: 'symbol',
                source: 'point-source',
                filter: ['has', 'point_count'],
                maxzoom: 12,
                layout: {
                    'text-field': '{point_count}',
                    'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
                    'text-size': 12,
                    'text-allow-overlap': true
                }
            });

            // 6. ê°œë³„ í¬ì¸íŠ¸ ë ˆì´ì–´ (í´ëŸ¬ìŠ¤í„° ë˜ì§€ ì•Šì€ ê²ƒ)
            map.addLayer({
                id: 'unclustered-point',
                type: 'circle',
                source: 'point-source',
                filter: ['!', ['has', 'point_count']],
                maxzoom: 12,
                paint: {
                    'circle-color': ['match', ['get', 'ì¢…ëª©ì½”ë“œ'], '11', '#e6194b', '12', '#3cb44b', '13', '#ffe119', '14', '#4363d8', '15', '#f58231', '16', '#911eb4', '18', '#888888', '#cccccc'],
                    'circle-radius': 6,
                    'circle-stroke-width': 1.5,
                    'circle-stroke-color': '#fff'
                }
            });

            // 7. PMTiles ì†ŒìŠ¤ ë° ìƒì„¸ í´ë¦¬ê³¤ ë ˆì´ì–´ (ì¤Œ 11 ì´ìƒ)
            map.addSource('pmtiles-source', {
                type: 'vector',
                url: 'pmtiles://my_map.pmtiles'
            });

            map.addLayer({
                'id': 'pmtiles-layer',
                'type': 'fill',
                'source': 'pmtiles-source',
                'source-layer': 'input', 
                'minzoom': 11,
                'paint': {
                    'fill-color': ['match', ['get', 'ì¢…ëª©ì½”ë“œ'], '11', '#e6194b', '12', '#3cb44b', '13', '#ffe119', '14', '#4363d8', '15', '#f58231', '16', '#911eb4', '18', '#888888', '#cccccc' ],
                    'fill-opacity': 0.7,
                    'fill-outline-color': '#ffffff'
                }
            });

            updateFilter(); // ì´ˆê¸° í•„í„° ì ìš©

        } catch (e) {
            console.error("ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜:", e);
        }

        // í´ë¦­ ì´ë²¤íŠ¸ í†µí•©
        map.on('click', (e) => {
            const features = map.queryRenderedFeatures(e.point, { layers: ['pmtiles-layer', 'unclustered-point'] });
            if (!features.length) return;

            const props = features[0].properties;
            const name = props['ë¬¸í™”ìœ ì‚°ëª…'] || 'ì •ë³´ì—†ìŒ';
            
            let html = `<strong>${name}</strong><br><hr>`;
            html += `<small>ì¢…ëª©ì½”ë“œ: ${props['ì¢…ëª©ì½”ë“œ']}</small>`;
            
            new maplibregl.Popup().setLngLat(e.lngLat).setHTML(html).addTo(map);
        });

        map.on('mouseenter', 'pmtiles-layer', () => map.getCanvas().style.cursor = 'pointer');
        map.on('mouseleave', 'pmtiles-layer', () => map.getCanvas().style.cursor = '');
    });

    // í•„í„° ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (PMTilesì™€ í´ëŸ¬ìŠ¤í„° ì  ëª¨ë‘ ì ìš©)
    function updateFilter() {
        const codes = ['11', '12', '13', '14', '15', '16', '18'];
        const enabledCodes = codes.filter(c => document.getElementById(`chk-${c}`).checked);
        
        const filterExp = enabledCodes.length === 0 
            ? ['==', ['get', 'ì¢…ëª©ì½”ë“œ'], 'none'] 
            : ['in', ['get', 'ì¢…ëª©ì½”ë“œ'], ['literal', enabledCodes]];

        if (map.getLayer('pmtiles-layer')) map.setFilter('pmtiles-layer', filterExp);
        if (map.getLayer('unclustered-point')) map.setFilter('unclustered-point', filterExp);
    }

    // ê²€ìƒ‰ ê¸°ëŠ¥
    function searchHeritage() {
        const keyword = document.getElementById('search-input').value.trim();
        const resultsDiv = document.getElementById('search-results');
        if (!keyword || !searchData) return;

        const matches = searchData.features.filter(f => f.properties['ë¬¸í™”ìœ ì‚°ëª…'] && f.properties['ë¬¸í™”ìœ ì‚°ëª…'].includes(keyword));
        
        resultsDiv.innerHTML = '';
        if (matches.length > 0) {
            resultsDiv.style.display = 'block';
            matches.slice(0, 10).forEach(f => {
                const item = document.createElement('div');
                item.className = 'result-item';
                item.innerText = `ğŸ“ ${f.properties['ë¬¸í™”ìœ ì‚°ëª…']}`;
                item.onclick = () => {
                    const coords = f.geometry.type === 'Point' ? f.geometry.coordinates : 
                                  (f.geometry.type === 'Polygon' ? f.geometry.coordinates[0][0] : f.geometry.coordinates[0][0][0]);
                    map.flyTo({ center: coords, zoom: 15 });
                    resultsDiv.style.display = 'none';
                };
                resultsDiv.appendChild(item);
            });
        } else {
            resultsDiv.style.display = 'none';
            alert("ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.");
        }
    }

    // ì—”í„°í‚¤ ê²€ìƒ‰ ì§€ì›
    document.getElementById('search-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') searchHeritage(); });
</script>
</body>
</html>
